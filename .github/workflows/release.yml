# Automated Release Workflow for NixOS Lima
#
# This workflow is triggered when a version tag (e.g., v0.0.4) is pushed.
# It automates the release procedure:
#   1. Waits for the build workflow to complete
#   2. Downloads the build artifacts
#   3. Creates a GitHub release
#   4. Uploads the images to the release
#   5. Creates a PR in nixos-lima-config-sample with updated URLs and hashes
#
# Required Secrets:
#   - RELEASE_PAT: A Personal Access Token with `repo` scope to create PRs
#                  in the nixos-lima/nixos-lima-config-sample repository.
#                  The token must have write access to that repository.

name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    env:
      VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for build workflow to complete
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            console.log(`Waiting for build workflow to complete for tag: ${tag}`);

            const maxAttempts = 60;
            const delaySeconds = 30;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              console.log(`Attempt ${attempt}/${maxAttempts}`);
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'build-image.yml',
                head_sha: context.sha,
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const run = runs.data.workflow_runs[0];
                console.log(`Build workflow status: ${run.status}, conclusion: ${run.conclusion}`);
                
                if (run.status === 'completed') {
                  if (run.conclusion === 'success') {
                    console.log('Build workflow completed successfully!');
                    core.setOutput('run_id', run.id);
                    return;
                  } else {
                    core.setFailed(`Build workflow failed with conclusion: ${run.conclusion}`);
                    return;
                  }
                }
              }
              
              if (attempt < maxAttempts) {
                console.log(`Waiting ${delaySeconds} seconds before next check...`);
                await new Promise(resolve => setTimeout(resolve, delaySeconds * 1000));
              }
            }

            core.setFailed('Timeout waiting for build workflow to complete');
          github-token: ${{ secrets.GITHUB_TOKEN }}
        id: wait-for-build

      - name: Download build artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux

          # Get the run ID for the build workflow
          RUN_ID=$(gh run list --workflow build-image.yml --branch ${{ env.VERSION }} --limit 1 --json databaseId --jq '.[0].databaseId')

          mkdir -p release-images

          echo "Downloading nixos-lima-unstable-aarch64..."
          gh run download "$RUN_ID" --name nixos-lima-unstable-aarch64 --dir release-images

          echo "Downloading nixos-lima-unstable-x86_64..."
          gh run download "$RUN_ID" --name nixos-lima-unstable-x86_64 --dir release-images

          # Rename images with version
          mv release-images/nixos-lima-unstable-aarch64.qcow2 release-images/nixos-lima-${{ env.VERSION }}-aarch64.qcow2
          mv release-images/nixos-lima-unstable-x86_64.qcow2 release-images/nixos-lima-${{ env.VERSION }}-x86_64.qcow2

          ls -la release-images/

      - name: Calculate SHA-512 hashes
        id: hashes
        run: |
          set -eux

          AARCH64_HASH=$(sha512sum release-images/nixos-lima-${{ env.VERSION }}-aarch64.qcow2 | cut -d' ' -f1)
          X86_64_HASH=$(sha512sum release-images/nixos-lima-${{ env.VERSION }}-x86_64.qcow2 | cut -d' ' -f1)

          echo "aarch64_hash=$AARCH64_HASH" >> "$GITHUB_OUTPUT"
          echo "x86_64_hash=$X86_64_HASH" >> "$GITHUB_OUTPUT"

          echo "SHA-512 (aarch64): $AARCH64_HASH"
          echo "SHA-512 (x86_64): $X86_64_HASH"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux

          gh release create ${{ env.VERSION }} \
            --title "Release ${{ env.VERSION }}" \
            --notes "## NixOS Lima ${{ env.VERSION }}

          ### Images

          | Architecture | SHA-512 |
          |--------------|---------|
          | aarch64 | \`${{ steps.hashes.outputs.aarch64_hash }}\` |
          | x86_64 | \`${{ steps.hashes.outputs.x86_64_hash }}\` |
          " \
            --prerelease

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux

          gh release upload ${{ env.VERSION }} \
            release-images/nixos-lima-${{ env.VERSION }}-aarch64.qcow2 \
            release-images/nixos-lima-${{ env.VERSION }}-x86_64.qcow2

      - name: Create PR in nixos-lima-config-sample
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          set -eux

          # Clone the config-sample repository
          git clone https://x-access-token:${GH_TOKEN}@github.com/nixos-lima/nixos-lima-config-sample.git config-sample
          cd config-sample

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create a new branch
          BRANCH_NAME="update-to-${{ env.VERSION }}"
          git checkout -b "$BRANCH_NAME"

          # Update nixos.yaml with new URLs and hashes
          # Using sed to replace the image URLs and digests
          AARCH64_URL="https://github.com/${{ github.repository_owner }}/nixos-lima/releases/download/${{ env.VERSION }}/nixos-lima-${{ env.VERSION }}-aarch64.qcow2"
          X86_64_URL="https://github.com/${{ github.repository_owner }}/nixos-lima/releases/download/${{ env.VERSION }}/nixos-lima-${{ env.VERSION }}-x86_64.qcow2"
          AARCH64_DIGEST="sha512:${{ steps.hashes.outputs.aarch64_hash }}"
          X86_64_DIGEST="sha512:${{ steps.hashes.outputs.x86_64_hash }}"

          # Create updated nixos.yaml using yq if available, otherwise use sed
          if command -v yq &> /dev/null; then
            yq -i ".images[0].location = \"$AARCH64_URL\"" nixos.yaml
            yq -i ".images[0].digest = \"$AARCH64_DIGEST\"" nixos.yaml
            yq -i ".images[1].location = \"$X86_64_URL\"" nixos.yaml
            yq -i ".images[1].digest = \"$X86_64_DIGEST\"" nixos.yaml
          else
            # Fallback to sed - update URLs and digests
            sed -i "s|location: \"https://github.com/${{ github.repository_owner }}/nixos-lima/releases/download/v[^/]*/nixos-lima-v[^-]*-aarch64.qcow2\"|location: \"$AARCH64_URL\"|" nixos.yaml
            sed -i "s|location: \"https://github.com/${{ github.repository_owner }}/nixos-lima/releases/download/v[^/]*/nixos-lima-v[^-]*-x86_64.qcow2\"|location: \"$X86_64_URL\"|" nixos.yaml
            
            # Update digests (match the line after the arch line)
            sed -i "/arch: \"aarch64\"/{n;s|digest: \"sha512:[^\"]*\"|digest: \"$AARCH64_DIGEST\"|}" nixos.yaml
            sed -i "/arch: \"x86_64\"/{n;s|digest: \"sha512:[^\"]*\"|digest: \"$X86_64_DIGEST\"|}" nixos.yaml
          fi

          # Show the changes
          git diff

          # Commit and push
          git add nixos.yaml
          git commit -m "Update to ${{ env.VERSION }}"
          git push origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "Update to ${{ env.VERSION }}" \
            --body "This PR updates the NixOS Lima images to ${{ env.VERSION }}.

          ## Changes

          - Updated aarch64 image URL and SHA-512 digest
          - Updated x86_64 image URL and SHA-512 digest

          ## Image Details

          | Architecture | SHA-512 |
          |--------------|---------|
          | aarch64 | \`${{ steps.hashes.outputs.aarch64_hash }}\` |
          | x86_64 | \`${{ steps.hashes.outputs.x86_64_hash }}\` |

          ---
          *This PR was automatically created by the release workflow.*" \
            --base main \
            --head "$BRANCH_NAME"
